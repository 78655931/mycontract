<link rel="stylesheet" href="__PUBLIC__/css/booking.css" type="text/css" media="screen" />
<link rel="stylesheet" href="__PUBLIC__/css/jquery.ui.css" type="text/css" media="all" /> 
<style>

	

	
     .bdt{
        border-top: 1px solid #000;
    }
    .bdl{
        border-left: 1px solid #000;
    }
    #optionfee,#option,#rate{
        border-bottom:1px solid #000;
    }
    .cr{
        text-align: right;
        float: right;
    }
	.list tr {
		margin-bottom: 10px;
	}

	.label-left{
		float: left;
		width:70px;
	}

	.label-right{
		float: left;
		width:100px;
	}

	.cost
	{
		margin-bottom: 8px;
	}
</style>
<script type="text/javascript">
	$(function(){
		$.ajaxSettings.global=false;
        optionprice('{$vo.BASE_RATE_QTY}');

        $( "#RECEIVABLE_DATE" ).datetimepicker({
            defaultdate: "+1w",
            timeFormat: 'hh:mm',
            showmonthafteryear: true,
            numberofmonths: 2,  
            mindate: 0 ,
            dateFormat:'yy-mm-dd',
            closetext:'关闭',
            duration: 'fast',
            showanim:'fadein',
            showon:'button', 
            buttontext:'选择日期',
            showbuttonpanel: false,
            stepHour: 1,//设置步长
            stepMinute: 15,
            stepSecond: 10,
            hourGrid: 4,
            minuteGrid: 10	
        });
	});
	
	function optionprice(days){

				var confirmation ='{$vo.agreement_id}';
				$.getJSON('__URL__/optionprice',{table:'agreement_option','CONFIRMATION':confirmation},function(data){
				var perunit;
				var unit;
				var flats;
				var totalPrice=0;

					$.each(data,function(i,item){
						//alert(item.OPTION_NAME);
						//$("#optionprice").text(item.OPTION_NAME);
					//$("<option></option>").val(item['CAR_TAG']).text(item.CAR_TAG).appendTo($('#cartags'));
						perunit = item.PER_UNIT;
				switch(perunit){
				case "1":
				unit="次";
				flats = parseInt(perunit);
				break;
				case "D":
				unit = "天";
				flats = days;
				break;
				case "H":
					unit = "每小时";
				break;
				case "W":
					unit = "每周";
				break;
				case "M":
					unit="每月";
				break;
				}
				if(item.MANDATORY=='N'){
					
				$("<div style='margin-bottom: 5px;'></div>").html('<div class="cost" id="cost-option-'+item['OPTION_ID']+ '" style="display:block;"><span class="item">'+item.OPTION_NAME+'</span><span class="price"><span class="option-qty">'+flats+'</span><span class="option-unit">'+unit+'*</span><span class="option-rate">' +item ['RATE'] + '</span>元*'+item.QTY+'个 ＝<span class="option-amt">' +flats*item.RATE*item.QTY + '</span> 元</span></div>').appendTo("#optionprice2");
				}else{

				$("<div style='margin-bottom: 5px;'></div>").html('<div class="cost" id="cost-option-'+item['OPTION_ID']+ '" style="display:block;"><span class="item">'+item.OPTION_NAME+'</span><span class="price"><span class="option-qty">'+flats+'</span><span class="option-unit">'+unit+'*</span><span class="option-rate">' +item ['RATE'] + '</span>元*'+item.QTY+'个＝<span class="option-amt">' +flats*item.RATE*item.QTY + '</span> 元</span></div>').appendTo("#mandytail");
				}

					//	$("<div style='margin-bottom: 5px;'></div>").html('<div class="cost" id="cost-option-'+item['OPTION_ID']+ '" style="display: block;"><span class="item">'+item ['OPTION_NAME']+'</span><span class="price"><span class="option-qty">'+days+'</span><span class="option-unit">天*</span><span class="option-rate">' +item ['RATE'] + '</span> 元 ＝<span class="option-amt">' +days*item.RATE + '</span> 元</span></div>').appendTo("#optionprice2");
						totalPrice +=days*item.RATE;
		});
					$("#total-amt").val(totalPrice);
		});
}

	/**
	**/
</script>
<div class="pageContent" layoutH="30">
	<!--table width="98%" class="list">
		<thead>
			<tr>
				<th width="100">预定人名称</th>
				<th width="200">取车时间</th>
				<th width="200">还车时间</th>
				<th width="200">预定车型</th>
				<th width="100">租金</th>
				<th width="100">租期类型</th>
				<th width="100">超天价格</th>
				<th width="100">超小时价格</th>
				<th width="100">费用总计</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{$vo.REAL_NAME}</td>
				<td>{$vo.PICKUP_DATE|substr=0,16}</td>
				<td>{$vo.RETURN_DATE|substr=0,16}</td>
				<td >{$vo.CAR_MODEL|getObjInfo='carModel','carModelCode','CAR_MODEL_NAME'}</td>
				<td >{$vo.RATE_AMT}</td>
				<td>自驾</td>
				<td>{$vo.XDAY}</td>
				<td>{$vo.XHOUR}</td>
				<td id="TOTAL_PRICE1">{$vo.TOTAL_PRICE}</td>
			</tr>
		</tbody>
	</table-->
	
	<form id="myform" action="__URL__/createagreement" method="post">
		<input type="hidden" name="REAL_NAME" value="{$vo.REAL_NAME}" />
		<input type="hidden" name="CAR_MODEL_NAME" value="{$vo.CAR_MODEL_NAME}"/>
		<input type="hidden" name="XDAY" value="{$vo.XDAY}"/>
		<input type="hidden" name="XHOUR" value="{$vo.XHOUR}" />
		<input type="hidden" name="TOTAL_PRICE" value="{$vo.TOTAL_PRICE}"/>
		<input type="hidden" name="confirmation" value="{$confirmation}"/>
		<input type="hidden" name="location_code" value="{$location_code}"/>

		<table class="list" width="98%" style="margin-top:10px;height:233px">
			<tr>
				<td colspan="2" style="text-align:center">会员信息</td>
			</tr>
			<tr>
				<td  style="width: 400px;">
					<label class="label-left">会员类型:</label>
					<input type="text" readonly name="MEMBER_TYPE_NAME" value="{$vo.MEMBER_TYPE_NAME}"/></td>
				<td>
					<label class="label-right">租车人手机:</label>
					<input type="text" readonly name="work_phone" value="{$vo.work_phone}"/>
				</td>
			</tr>	
			<tr>
				<td  style="width: 400px;">
					<label class="label-left">姓名:</label>
					<input type="text" readonly  readonly id="REAL_NAME" name="REAL_NAME" value="{$vo.REAL_NAME}"/>	</td>
				<td>
					<label class="label-right">紧急联系人:</label><input type="text" readonly name="contactperson" value="{$vo.contactperson}"/>
					电话:<input type="text" readonly name="contactphone" value="{$vo.contactphone}"/>
				</td>
			</tr>	
			<tr>
				<td  style="width: 400px;">
					<label class="label-left">性别:</label>
					<input type="text" readonly readonly name="sex" id="sex" value="{$vo.sex}"/>
					出生日期:<input type="text" readonly readonly name="age" readonly value="{$vo.age}"/>
				</td>
				<td>
					<label class="label-right">驾驶证号码:</label>
					<input type="text" readonly name="IDENTITY_CODE" value="{$vo.IDENTITY_CODE}"/>
					<input type="hidden" name="DRIVER_CODE" value="{$vo.IDENTITY_CODE}"/>
				</td>
			</tr>	
			<tr>
				<td  style="width: 400px;">
					<label class="label-left">电子邮件:</label>
					<input type="text" readonly name="email" value="{$vo.email}" />
				</td>
				<td>
					<label class="label-right">驾驶证准驾车型:</label>
					<input type="text" readonly value={$vo.vehicletype} />
				</td>
			</tr>	
			<tr>
				<td  style="width: 400px;">
					<label class="label-left">身份证号码:</label>
					<input type="text" readonly readonly id="IDENTITY_CODE" name="IDENTITY_CODE" value="{$vo.IDENTITY_CODE}"/>

				</td>
				<td>
					<label class="label-right">发证城市:</label>
					<input type="text" readonly name="driverofcity" value="{$vo.driverofcity}"/>

				</td>
			</tr>	
			<tr>				<td  style="width: 400px;">
					<label class="label-left">身份证地址:</label>
					<input type="text" readonly readonly name="address" size="50"  value="{$vo.address}"/>

				</td>
				<td>
					<label class="label-right">初次领证日期:</label>
					<input type="text" readonly  name="taketime" value="{$vo.taketime}" />

				</td>
			</tr>	
			<tr>
				<td  colspan="2" style="width: 400px;">
					<label class="label-left">现住址:</label>
					<input type="text" readonly size="50" name="consummeraddr" value="{$vo.consummeraddr}" />

				</td>
			</tr>	
		</table>	
		<table class="list" width="98%" style="margin-top:10px">
			<tbody>
				<tr>
					<td style="width: 270px;text-align:center">
						<ul>
							<li style="font-weight: bold">
							租期:<span>共</span><span id="delta-t" style="color: #fd6c02;">{$vo.BASE_RATE_QTY}</span>天
							</li>						</ul>
						<input type="hidden" name="BASE_RATE_QTY" value="{$vo.BASE_RATE_QTY}"/>
						<br />
						<div style="display:block;margin-bottom:10px">
							<label style="width:15px">实际取车时间:</label>	
							<input type="text" readonly  name="PICKUP_DATE"    value="{$vo.PICKUP_DATE}"   id="from"/>	
						</div>
						<div style="display:block;margin-bottom:10px">
							<label style="width:15px">实际还车时间:</label>
							<input type="text" readonly id="to" name="RETURN_DATE"  value="{$vo.RETURN_DATE|substr=0,16}" />

						</div>
					</td>
					<td>

						<table class="list" width="100%" style="height:80px">
							<thead>
								<tr>
									<th width="60">车牌号</th>
									<th width="80">车辆品牌</th>
									<th width="200">车辆型号</th>
									<th width="100">当前里程</th>
									<th width="100">当前油量</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td><input class="readonly"  value="{$vo.CAR_TAG}" readonly="readonly" type="text"/></td>
									<td>
										<input class="readonly" value="{$vo.CAR_MODEL}"  readonly="readonly" type="text"/>
									</td>
									<td>
										<input class="readonly" value="{$vo.CAR_MODEL_NAME}" size="40" readonly="readonly" type="text" />
									</td>
									<td>
										<input class="text"  value="{$vo.CURRENT_KM}" readonly="readonly" type="text" />
									</td>
									<td>
										<input class="text" value="{$vo.CURRENT_OIL|getOilpercent}" readonly="readonly" type="text" />
									</td>
								</tr>
							</tbody>
						</table>

					</td>
				</tr>
			</tbody>
		</table>

		<table class="list" width="98%" style="margin-top:10px">
			<tbody>
				<tr>
					<td style="width:270px;">

						<input type="hidden" name="RATE_AMT" value="{$vo.BASE_RATE_AMT}"/>
						<input type="hidden" name="CURRENT_KM" value="{$vo.CURRENT_KM}"/>
						<input type="hidden" name="MANDATORY_CHARGES" value="{$vo.MANDATORY_CHARGES}"/>
						<input type="hidden" name="BASE_RATE_QTY" value="{$vo.BASE_RATE_QTY}"/>


                        <h1 style="margin-bottom:20px">价格计算(租期<span id="delta-o" style="color: #fd6c02;">{$vo.BASE_RATE_QTY}</span>天)</h1>

                        <table width="98%">
                            <tr>

                                <td>基本租金</td>
                                <td class="cr" id="optionfee">
                                    <span class="option-amt">{$vo.RATE_AMT}</span>
                                </td>
                            </tr>
                            <tr>
                                <td>必须费用</td>
                                <td class="cr" id="optionfee">
                                    <span id="mandytail"></span>
                                    
                                    <label>小计: </label><span class="option-amt">{$vo.MANDATORY_CHARGES}</span>元
                                </td>

                            </tr>
                            <tr>
                                <td>增值服务</td>
                                <td  id="optionfee" class="cr"> 
                                    <table id="optionprice">
                                    </table>
                                    <div class="board"></div>
                                    <span id="optionprice2"> {$location_code|optionPrice=$Think['get']['id'],$vo['BASE_RATE_QTY']} </span>

                                    <label  id="feeoption">小计: </label><span class="option-amt" id="charge">{$vo.OPTIONS_CHARGES}</span>元
                                </td>
                            </tr>
                            
                            <tr>
                                <td>应收金额</td>
                                <td  class="cr" ><span id="total-amt">{$vo.TOTAL_PRICE}</span>  元</td>
                            </tr>
                            <tr>
                                <td>实收金额</td>
                                <td class="cr" ><span id="total-real">{$vo.REALTOTAL}</span> 元</td>
                            </tr>
                            <tr>
                                <td>付款方式</td>
                                <td class="cr">
<if condition="$vo['PAYMENT' eq 1]">月结<elseif condition="$vo['PAYMENT' eq 2]"/>现金<elseif condition="$vo['PAYMENT'] eq 3"/>对私转帐<elseif condition="$vo['PAYMENT'] eq 4"/>对公转帐<elseif condition="$vo['PAYMENT'] eq 5"/>在线支付<else/>司机代收</if>
                                </td>
                            </tr>
                            <tr>
                                <td>结算总金额</td>
                                <td class="cr">{$vo.RETURN_FEE}元</td>
                            </tr>
                        </table>
							
					</td>
					<td>	
						<h1>增值服务</h1>
						<div style="width:220px">	{$vo.agreement_id|getOptions}
						</div>

					</td>
					
				</tr>
				<tr>
					<td colspan="2">						<a target="_blank" mask=true max=true maxable=true minable=true resizable=true drawable=true ref="contract"  href="__URL__/gotoPrint/agreementid/{$Think.get.id|base64_encode}">打印合同</a>					</td></tr>	
			</tbody>
		</table>
    </form>
    <!--flags 是0，表示还有未付款的金额-->
             <if condition="($vo['status'] eq 'RETURN') and ($flags eq '0')">
              <form action="__URL__/insertAccount/navTabId/__MODULE__" class="pageForm required-validate" onsubmit="return validateCallback(this, dialogAjaxDone)" method="post">
                <input name="AGREEMENT_ID" value="{$vo.agreement_id}" type="hidden" />
                <input name="LOCATION_CODE" type="hidden" value="{$Think.session.location_code}"/>
                <input name="AGREEMENT_ID" value="{$vo.agreement_id}" type="hidden" />
                <input type="hidden" name="LAST_UNRECEIVED_MONRY" value="{$LAST_UNRECEIVED_MONRY['UNRECEIVED_MONRY']}" />
                <input name="RETURN_FEE" type="hidden" value="{$vo.RETURN_FEE}"/>
                <table class="list" width="100%">
                    <tr>
                        <th>收款时间</th>
                        <th>收款金额</th>
                        <th>支付方式</th>
                        <th>车牌号码</th>
                        <th>车辆品牌</th>
                        <th></th>
                    </tr>
                    <tr>
                        <td><input id="RECEIVABLE_DATE" name="RECEIVABLE_DATE" value="{$vo.RETURN_DATE}" type="text" /></td>
                        <td><input id="" name="RECEIVABLE_MONEY" type="text" /></td>
                        <td>
                            <SELECT  name="PAYMENT">
                                <OPTION value="1">月结</OPTION>
                                <OPTION value="2">现金</OPTION>
                                <OPTION value="3">对私转帐</OPTION>
                                <OPTION value="4">对公转帐</OPTION>
                                <OPTION value="5">在线支付</OPTION>
                                <OPTION value="6">司机代收</OPTION>
                            </SELECT>
                        </td>
                        <td><input id="" name="CAR_TAG" type="text" value="{$vo.CAR_TAG}" /></td>
                        <td><input id="" name="CAR_MODEL" type="text" value="{$vo.CAR_MODEL}"/></td>
                        <td><input type="submit" value="增加" /></td>
                    </tr>
                </table>
            </form>
            </if>
            <if condition="($vo['status'] eq 'RETURN') or ($vo['status'] eq 'CLOSE')">
            <table class="list" width="100%">
                <tr>
                    <th>收款时间</th>
                    <th>收款金额</th>
                    <th>支付方式</th>
                    <th>未收款金额</th>
                    <th>车主</th>
                    <th>车牌号码</th>
                    <th>车辆品牌</th>
                    <th></th>
                </tr>
                <volist name="accounts" id="account">
                <tr>
                    <td>{$account.RECEIVABLE_DATE}</td>

                    <td>{$account.RECEIVABLE_MONEY}</td>
                    <td>
                       <if condition="$account['PAYMENT'] eq 1">月结<elseif condition="$account['PAYMENT'] eq 2"/>现金<elseif condition="$account['PAYMENT'] eq 3"/>对私转帐<elseif condition="$vo['PAYMENT'] eq 4"/>对公转帐<elseif condition="$vo['PAYMENT'] eq 5"/>在线支付<else/>司机代收</if> 
                       </td>
                    <td>{$account.UNRECEIVED_MONRY}
                    </td>
                    <td>{$account.MOTORCAR_OWNER}</td>
                    <td>{$account.CAR_TAG}</td>
                    <td>{$account.CAR_MODEL}</td>
                </tr>
                </volist>
            </table>
            </if>
            <if condition="($vo['status'] eq 'RETURN') and $flags neq '0'">

            <form action="__URL__/closeContract/navTabId/__MODULE__" class="pageForm required-validate" onsubmit="return validateCallback(this, dialogAjaxDone)" method="post">

                <input name="id" value="{$vo.id}" type="hidden" />
                <input name="status" value="CLOSE" type="hidden" />
                  <input type="submit" value="关闭合同" />
                  </form>
            </if>
</div>


